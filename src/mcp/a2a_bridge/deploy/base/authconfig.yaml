---
# AuthConfig for A2A MCP Bridge
# Defines authentication and authorization rules
#
# Flow:
# 1. Extract JWT from Authorization header
# 2. Validate against Keycloak (issuerUrl replaced by kustomize)
# 3. Inject user identity as headers for MCP server
apiVersion: authorino.kuadrant.io/v1beta2
kind: AuthConfig
metadata:
  name: a2a-mcp-bridge-auth
  namespace: a2a-mcp-bridge
spec:
  # Apply to MCP bridge service
  hosts:
  - "a2a-mcp-bridge.a2a-mcp-bridge.svc.cluster.local"

  # AUTHENTICATION: Validate JWT token
  authentication:
    "keycloak-jwt":
      credentials:
        authorizationHeader:
          prefix: Bearer
      jwt:
        # This value is replaced by kustomize from discovered Keycloak URL
        issuerUrl: KEYCLOAK_ISSUER_URL_PLACEHOLDER

  # RESPONSE: Inject headers for MCP server to consume
  # Extract user info directly from validated JWT claims
  response:
    success:
      headers:
        "X-Auth-User":
          plain:
            selector: auth.identity.preferred_username
        "X-Auth-Email":
          plain:
            selector: auth.identity.email
        "X-Auth-Groups":
          plain:
            selector: auth.identity.groups | @json
        "X-Auth-Token":
          # Pass original token so MCP server can call Kubernetes API
          plain:
            selector: auth.credentials.access_token

  # Don't require auth for health checks
  when:
  - selector: context.request.http.path
    operator: neq
    value: /healthz
